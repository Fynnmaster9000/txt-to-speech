<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Text to Speech with Voice Switch and Download</title>
<style>
  body { font-family: Arial, sans-serif; margin: 2em; }
  label.switch {
    position: relative; display: inline-block; width: 60px; height: 34px;
  }
  label.switch input {opacity: 0; width: 0; height: 0;}
  .slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: #ccc; transition: .4s; border-radius: 34px;
  }
  .slider:before {
    position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px;
    background-color: white; transition: .4s; border-radius: 50%;
  }
  input:checked + .slider {background-color: #2196F3;}
  input:checked + .slider:before {transform: translateX(26px);}
  #buttons { margin-top: 1em; }
  button {
    padding: 0.5em 1em;
    font-size: 1em;
    margin-right: 10px;
  }
</style>
</head>
<body>

<h1>Text to Speech (Male/Female Switch)</h1>

<textarea id="textInput" rows="5" cols="40" placeholder="Enter text here..."></textarea>
<br/><br/>

<label class="switch">
  <input type="checkbox" id="voiceSwitch" />
  <span class="slider"></span>
</label>
<span id="voiceLabel">Female Voice</span>

<br/><br/>
<div id="buttons">
  <button id="playButton">Play Speech</button>
  <button id="downloadButton">Download Audio</button>
</div>

<script>
  let voices = [];
  let maleVoice = null;
  let femaleVoice = null;

  function loadVoices() {
    voices = speechSynthesis.getVoices();

    femaleVoice = voices.find(voice => /female|woman|girl/i.test(voice.name)) || voices[0];
    maleVoice = voices.find(voice => /male|man|boy/i.test(voice.name)) || voices[0];

    if (!femaleVoice) femaleVoice = voices[0];
    if (!maleVoice) maleVoice = voices[0];
  }

  if (speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = () => {
      loadVoices();
    };
  }

  loadVoices();

  const textInput = document.getElementById('textInput');
  const playButton = document.getElementById('playButton');
  const downloadButton = document.getElementById('downloadButton');
  const voiceSwitch = document.getElementById('voiceSwitch');
  const voiceLabel = document.getElementById('voiceLabel');

  voiceSwitch.addEventListener('change', () => {
    voiceLabel.textContent = voiceSwitch.checked ? 'Male Voice' : 'Female Voice';
  });

  playButton.addEventListener('click', () => {
    let text = textInput.value.trim();
    if (!text) {
      alert('Please enter some text.');
      return;
    }
    if (!speechSynthesis) {
      alert('Sorry, your browser does not support speech synthesis.');
      return;
    }

    let utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = 1;
    utterance.voice = voiceSwitch.checked ? maleVoice : femaleVoice;

    speechSynthesis.cancel();
    speechSynthesis.speak(utterance);
  });

  // Download audio using Web Audio API + SpeechSynthesis + MediaRecorder trick
  downloadButton.addEventListener('click', () => {
    let text = textInput.value.trim();
    if (!text) {
      alert('Please enter some text to download.');
      return;
    }

    if (!speechSynthesis) {
      alert('Sorry, your browser does not support speech synthesis.');
      return;
    }

    // Create audio context and destination node
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();

    // Create a dummy oscillator to keep audio context alive
    const oscillator = audioCtx.createOscillator();
    oscillator.connect(audioCtx.destination);
    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.01);

    // Create a MediaStreamAudioDestinationNode
    const dest = audioCtx.createMediaStreamDestination();

    // Setup utterance with voice
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.voice = voiceSwitch.checked ? maleVoice : femaleVoice;
    utterance.rate = 1;

    // Create a MediaRecorder from destination stream
    const mediaRecorder = new MediaRecorder(dest.stream);
    const chunks = [];

    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'audio/wav' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = 'tts_output.wav';
      document.body.appendChild(a);
      a.click();

      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      audioCtx.close();
    };

    // Connect speechSynthesis audio to destination â€” 
    // Unfortunately, speechSynthesis does NOT support routing audio to Web Audio API directly
    // So this method doesn't work reliably across browsers.

    // Workaround: Just play the speech, ask user to record audio externally, or use server-side TTS.

    alert('Downloading speech audio is not supported directly by browsers via SpeechSynthesis API.\n\nPlease use "Play Speech" and record with an external tool.');

  });
</script>

</body>
</html>
